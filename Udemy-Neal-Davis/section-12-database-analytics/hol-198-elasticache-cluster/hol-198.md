# Create ElastiCache Cluster - HOL-198

### Description

This configuration creates an ElastiCache Redis Cluster.  
It also creates an EC2 instance which can then be used to Run a Python script that insert data into the Redis instance.

### Operation

**Before deployment**

**Deployment**

Lint the template

```bash
$ cfn-lint ElastiCache.yaml
```

Deploy the stack

```bash
$ aws cloudformation deploy --template-file ElastiCache.yaml --stack-name ElastiCache  --parameter-overrides file://private-parameters.json
```

**After deployment**

1. Get the `PrimaryEndPoint` and `PublicIp` from the stack output

```bash
$ aws cloudformation describe-stacks --stack-name ElastiCache --query "Stacks[0].Outputs" --no-cli-pager
```

2. Use the `PrimaryEndPoint` to update the _primary_endpoint_ variable value in the Python script `main.py`.
3. Copy the `main.py` script to the EC2 instance

```bash
$ scp -i dev-simple-key.pem main.py ec2-user@18.171.159.238:~/
```

4. SSH into the EC2 instance.

```bash
$ ssh -i dev-simple-key.pem ec2-user@18.171.159.238
```

5. Install the dependencies if they were not installed properly by the UserData script

```bash
## PIP
curl -O https://bootstrap.pypa.io/get-pip.py
python3 get-pip.py --user
## Redis
pip install redis
```

**Testing**
Run the Python script in the EC2 instance

<!-- @todo:  This script is not working - it gets stuck even in the EC2 instance-->

```bash
$ python3 main.py
```

**Cleanup**

To delete the stack

```bash
$ aws cloudformation delete-stack --stack-name ElastiCache
```
